---
title: "secuTrialR - a walk through"
author: "Patrick R. Wright"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{secuTrialR-package-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

> “If I had just five minutes to chop down a tree I would spend the first two and a half minutes sharpening my axe.”

> `r tufte::quote_footer('--- An anonymous woodsman')`

# Introduction

This R package provides functions for handling data from the clinical data management system (CDMS) 
[\textcolor{blue}{secuTrial}](https://www.secutrial.com/en/).
The most important components are related to reading data exports from secuTrial into R. In brief, the package
aims to enable swift execution of repetitive tasks in order to allow spending more time on the unique aspects
of a dataset. It is developed and maintained by the Swiss Clinical Trial Organisation ([\textcolor{blue}{SCTO}](https://www.scto.ch/en/news.html)).

This vignette will teach you how to use the `secuTrialR` package and you will likely learn quite a bit about secuTrial
exports in general along the way.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Installing

Lets get started by installing the package straight from 
[\textcolor{blue}{GitHub}](https://github.com/SwissClinicalTrialOrganisation/secuTrialR)
and then loading it. For this you will need to have `devtools` installed.
\vspace{5pt}

```{r, eval = FALSE}
# install
devtools::install_github("SwissClinicalTrialOrganisation/secuTrialR")
```

```{r}
# load
library(secuTrialR)
# show secuTrialR version
installed.packages()["secuTrialR", "Version"]
```

# The CTU05 dataset

Before we continue with the functionalities lets briefly talk about the test data which is
delivered as a part of the package. We refer to it as the `CTU05` (clinical trial unit project 05) data.
This dataset has been fabricated for demonstrarion purposes only and is not real clinical data.
Principally it is made up of eight forms. These are called "surgeries", "baseline", "outcome", 
"treatment", "allmedi", "studyterminat", "ae" and "sae". You will see these names again later when 
the data has been read into R.
The project setup includes most data types implementable in secuTrial. It is, however, not exhaustive.
Since it is delivered with the installation of the `secuTrialR` package we can point to it via the
`system.file()` function. 
\vspace{5pt}

```{r}
ctu05_data_location <- system.file("extdata", "sT_exports", "export_options",
                                   "s_export_CSV-xls_CTU05_20191003-144349_all_info.zip",
                                   package = "secuTrialR")
```

If you work on your own datasets you can specify a path as a regular charater without using `system.file()`.

\newpage

# secuTrial data export options

Before reading your data into R you need to export it with the secuTrial ExportSearchTool.
We suggest exporting **non rectangular**, **zipped**, **English** data with 
**reference values** stored **in a separate table** including 
**Add-IDs**, **centre information**, **form status**, **project setup**
and **without duplicated meta data**. Furthermore it is suggested to use
**UTF-8** encoding and **"CSV format"**/**"CSV format for MS Excel"**.
Most of these options are truly optional and reading your data should
work even with differences from the above specifications.

# Reading a secuTrial data export into R

There is one princtiple way to read your data. You should use `read_secuTrial()`.
Below you can see it in action with the `CTU05` dataset.
\vspace{5pt}

```{r}
ctu05_data <- read_secuTrial(data_dir = ctu05_data_location)
```

If the "Read export successfully." message appears your data was correctly read.

# The secuTrialdata object

If you inspect the `class()` of `ctu05_data` you will find that it is a `secuTrialdata` object.
\vspace{5pt}

```{r}
class(ctu05_data)
```

Really this is only a list containing all the information from your secuTrial export.

```{r}
typeof(ctu05_data)
```

## The data tables in the secuTrialdata object

We have implemented a custom variation of the `print()` function for `secuTrialdata` objects.

**TODO: This will not wrap which is a little annoying.**

```{r}
print(ctu05_data)
```

It shows you where the export archive of your `secuTrialdata` object is located, tells you which
tables (i.e. `table`) it contains, what the source files (i.e. `original_name`) are and
specifies each table's dimensions (i.e. `ncol`, `nrow`). 

By now you have possibly realized that all the forms specified earlier (i.e. "surgeries", "baseline", "outcome", 
"treatment", "allmedi", "studyterminat", "ae" and "sae") are present, but also that there are many tables
which you do not recognize.

The majority of the unrecognizable tables are tagged as `TRUE` in the `meta` column. This means that they are structural
data tables. Their names and data structures are fixed in all secuTrial exports. In the following we will briefly explain
which information the most relevant meta tables contain.

* `vp` - visitplan definition
* `vpfs` - visitplan form linkage
* `fs` - forms information
* `qs` - questions
* `is` - items i.e. variable definitions
* `ctr` - centre information
* `cn` - casenodes i.e. list of entered study participants
* `cl` - information how the data in the variables is coded

Furthermore, there is a set of tables whose names start with "at". These are audit trail tables. Last but not least
you may have also realized that the "surgeries" table is called `esurgeries`. This is because it is a so-called repetition
form. Repetition forms are labelled with a leading "e" and are implemented as subforms in other forms. In this case,
`esurgeries` is a subform in `baseline` and the linkage is defined by the `mnpdocid` column in both tables. If this sounds
cryptic to you I suggest you talk so someone who has implemented a data base in secuTrial and let them explain it with a
specific example.

## Accessing the tables and values

Since the `secuTrialdata` object is a list and the data tables within this list are data frames you can simply access the tables using `$`.
Lets say you would like to have a look at the placebo to verum ratio in your `treatment` data or what types of other medication were entered in
`allmedi`.

```{r}
table(ctu05_data$treatment$rando_treatment)
table(ctu05_data$allmedi$med_product)
```

## Export options

The `secuTrialdata` object also contains information on the export options.

```{r}
ctu05_data$export_options
```

`export_options` itself is a `list`. If you are interested in more information than is printed you can also access it.
Lets assume you would like to know the `project_name` and `encoding`.

```{r}
ctu05_data$export_options$project_name
ctu05_data$export_options$encoding
```

Much more information is stored in the elements of `export_options` and their names should be descriptive.
```{r}
names(ctu05_data$export_options)
```

\newpage


And finally here is the `sessionInfo()`

```{r}
sessionInfo()
```

Disclaimer:

The descriptions of the export data and the linkages within are our understanding of them and come with no warranty.
For in depth details please refer to the original secuTrial manuals.
